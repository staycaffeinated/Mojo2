# The Mojo Code Generator

This utility enables generating boilerplate code with simple
command line arguments. The utility currently supports:

* RESTful web services based on Spring
               
## Features

A project generated by Mojo has these features:       

* Uses Spring framework
* Uses Gradle build files  
* Generates unit and integration tests that provide 90% code coverage
* Support for: Postgres, H2, Liquibase, TestContainers
* Generates a docker-compose.yaml file to launch the micro-service and database
* Support for SonarQube to enable code coverage analysis
* Generates a README file with instructions on how to build and maintain the generated code
* Secure, random resource IDs with 160-bit entropy    

## Installation

A Homebrew Tap exists for this code.  To install with homebrew, do this:

```[bash]
brew tap staycaffeinated/mojo
brew install mojo
```
To verify the installation, run:

`mojo --version`

## Mojo Command Line Usage:

First, it is important to know the project assets will be created in your current
directory, so be sure to navigate to the folder in which 
you want the project assets created before running any command.

POSIX-style syntax is supported, allowing options to be specified as 
```-option value``` or as ```-option=value```.

The command             

    mojo rest-api create-project --help 

shows the different options for creating a project. The simplest way to
create a project is specify a name, base package, and base path, such as:

    mojo rest-api create-project --name adventure --package org.example.adventure --base-path /api/adventure/v1 

which creates the project assets in the current directory,
with the default Java package name of ```org.example.adventure``` and
a base URL of ```http://localhost:8080/adventure```

A base project will have a root controller that returns an HTTP 200 without a response body.
To add additional controllers, use the ```create-endpoint``` sub-command.
For example,

    mojo rest-api create-endpoint -resource Treasure -route /treasure

### Build and run the generated code

Step 1: Create the gradle wrapper

```gradle wrapper```
                 
Step 2: Compile the code

```./gradlew build```

Step 3: Spin up the application

```./gradlew bootRun```

or, to run the application in Docker,

```
./gradlew bootBuildImage
cd docker-compose
docker-compose up -d
```

Step 4: Exercise the running application

An example of posting a resource:

```[bash]
curl -X POST http://localhost:8080/adventure/treasure -H 'Content-type: application/json' -d '{ "text" : "a lantern"  }' 
curl -X POST http://localhost:8080/adventure/treasure -H 'Content-type: application/json' -d '{ "text" : "a knife" }'
```

An example of fetching a resource:

```[bash]
curl http://localhost:8080/adventure/treasure/                 // fetches all the treasures
curl http://localhost:8080/adventure/treasure/{{resourceId}}   // fetch a specific treasure
```

Check the health of the microservice

```[bash]
curl http://localhost:8080/adventure/_internal/health
```


## Build Process

This section discusses how to build this code base.

NOTE: Java 11 is required; Jacoco does not yet support later versions (support for java 15
is in beta, but not working at the time I added this note).
                    
### Compile

```./gradlew build```. 

### Build, test, and export the test coverage to Sonarqube

```./gradlew clean build codeCoverageReport sonarqube```

### To Deploy the Application from the Compiled Code

Navigate to the ```mojo``` sub-project, then to the ```build/distributions``` folder.
(that is, ```cd mojo/build/distributions```). (DO NOT use the tar/zip file
created in the project root build/distributions folder; that is not the uber jar.)

Copy the ```mojo-shadow.tar``` (or ```zip```) to the desired location
and unpack it, then add the ```mojo/bin/mojo``` executable to your PATH. 
                      
### To Extend the Application

The general approach to extending Mojo by adding more
sub-commands is to create a module folder for the new
sub-command and add the appropriate code there. The
```mojo``` module can then be updated to link to the 
new sub-module. 

For example, to add a ```reactive-api``` sub-command, do
these steps:

1. create a ```reactive-api``` folder and the usual 
   assets (src/main/java; src/main/resources; etc)

2. Update the ```mojo/build.gradle``` to have a project 
   dependency on the ```reactive-api``` module.
   
3. Update the MojoApplication.java class to add
```reactive-api``` as a sub-command. The Picocli 
   library requires sub-commands to be explicitly
   set at compile-time.
   
4. Rebuild Mojo, deploy the new version of the Mojo
   application and do the appropriate testing of
the new ```reactive-api``` sub-command to ensure
   the generated code works as you expect. 
   

### Keeping library versions up-to-date

The ```build.gradle``` imports the gradle-versions-plugin (See https://github.com/ben-manes/gradle-versions-plugin)
which adds tasks for library version management. 

##### Task: dependencyUpdates

```./gradlew dependencyUpdates```

This renders a report to the terminal (as part of the gradle output) 
of project dependencies that are up-to-date, or have updates available.

To refresh the dependency cache, use 

```./gradlew dependencyUpdates --refresh-dependencies```

Another example, showing other options:

```./gradlew dependencyUpdates -Drevision=release -DoutputFormatter=json -DreportfileName=version-report```

The report from the shown command is written to the ```[projectRoot]/build/dependencyUpdates``` directory. 

### Code Coverage and SonarQube

A ```codeCoverageReport``` task is available in the build.gradle. To get code coverage, run the command:

```./gradlew test integrationTest codeCoverageReport sonarqube```

### Setting up SonarQube

Step 1:  Run this command:

```docker run -d --name sonarqube -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true -p 9000:9000 sonarqube:latest```

Step 2: Login to the SonarQube console at localhost:9000. You'll be prompted to change
the default password (admin/admin). Pick something and update this repo's gradle.properties
file with the new password. See [Getting Started](#### Setting up SonarQube) to get up to
speed with SonarQube.
